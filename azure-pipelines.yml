trigger:
- main

pool:
  name: Default   # Self-hosted agent pool

variables:
  appServer: "13.235.31.157"
  appUser: "ubuntu"

steps:

- checkout: self

# Step 1 - Make build executable
- script: |
    chmod +x build.sh
  displayName: "Make build.sh executable"

# Step 2 - Run build
- script: |
    ./build.sh
  displayName: "Run build.sh"

# Step 3 - Find WAR dynamically
- script: |
    echo "Searching for WAR file..."
    WAR_FILE=$(find . -type f -name "*.war" | head -n 1)

    if [ -z "$WAR_FILE" ]; then
      echo "ERROR: No WAR file found!"
      exit 1
    fi

    echo "WAR found at: $WAR_FILE"
    echo "##vso[task.setvariable variable=WAR_PATH]$WAR_FILE"
  displayName: "Locate WAR file"

# Step 4 - Deploy WAR to AWS
- script: |
    echo "Deploying $(WAR_PATH) to AWS..."
    scp "$(WAR_PATH)" $(appUser)@$(appServer):/var/lib/tomcat9/webapps/
  displayName: "Deploy WAR to AWS EC2"

# Step 5 - Restart Tomcat
- script: |
    ssh $(appUser)@$(appServer) "sudo systemctl restart tomcat9"
  displayName: "Restart Tomcat on AWS"
